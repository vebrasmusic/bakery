---
name: bakery-worktree-bootstrap
description: Patch an existing Node.js repository to run in Bakery-managed worktrees with generated setup.sh/dev.sh, Bakery slice-based port allocation, and .env wiring. Use when you need deterministic multi-worktree dev startup, switchable app ports, pie/slice validation, and clean Ctrl-C teardown without shutting down the global Bakery daemon.
---

# Bakery Worktree Bootstrap

Patch-only skill for Node repositories that should run development environments through Bakery slice allocation.

## Workflow

1. Run `scripts/patch_bakery_runtime.sh --target .`.
2. Confirm the detection summary for package manager, dev command, DB provider, compose file, and resource plan.
3. Run generated setup:
   - `./setup.sh --pie <pie-id-or-slug>`
4. Run development:
   - `./dev.sh`

## Patcher CLI

```bash
# Auto-detect Node runtime + Bakery mapping
./scripts/patch_bakery_runtime.sh --target .

# Override detected values
./scripts/patch_bakery_runtime.sh \
  --target . \
  --package-manager pnpm \
  --dev-cmd "pnpm run dev" \
  --db-provider postgres \
  --compose-file docker-compose.yml \
  --db-service db \
  --migrate-cmd "pnpm run db:migrate" \
  --seed-cmd "pnpm run db:seed" \
  --db-tool-cmd "pnpm run db:studio"
```

## Generated Files

- `.bakery-runtime.json`: managed runtime manifest (commands, DB model, resource plan, env port keys)
- `setup.sh`: one-shot setup that validates Bakery, validates pie, allocates/reuses slice, writes `.env`
- `dev.sh`: runtime launcher with compose + app + optional DB tool and clean shutdown
- `.bakery-slice.json`: local slice state generated by `setup.sh`

## Setup Behavior

`setup.sh` requires `--pie`.

Optional flags:

- `--new-slice`: force a new slice allocation
- `--reuse-slice`: force reuse of existing `.bakery-slice.json` when valid
- `--numresources <n>`: override detected resource count
- `--with-migrate`: run detected migrate command after setup
- `--with-seed`: run detected seed command after setup

Default slice policy:

- If `.bakery-slice.json` exists and still resolves, prompt in TTY to reuse.
- In non-interactive mode, reuse when valid; otherwise create a new slice.

## Dev Behavior

`dev.sh`:

- loads `.bakery-runtime.json` and `.env`
- starts dockerized DB (when configured)
- starts optional DB tool command
- launches app with `PORT`/`APP_PORT` and detected explicit `--port` wiring when known
- traps `INT/TERM/EXIT` and stops app/DB resources only
- does not run `bakery down`

## Notes

- This skill targets Node repos in v1 (requires `package.json`).
- Bakery must be available on `PATH` for generated setup/dev scripts.
- Re-run patcher any time detection inputs change; managed content is regenerated while user blocks are preserved.
